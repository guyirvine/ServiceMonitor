#!/usr/bin/env ruby

# Add the currently running directory to the start of the load path
$:.unshift './'

require 'net/smtp'
require 'Alert'
require 'Alert/Email'
require 'MonitorType'
require 'MonitorType/Threshold'
require 'MonitorType/Beanstalk'
require 'MonitorType/Dir'
require 'MonitorType/FluidDb'
require 'MonitorType/Process'
require 'MonitorType/HttpGetJsonList'
require 'MonitorManager'
require 'helper_functions'

# Don't buffer stdout
$stdout.sync = true

abort('Usage: servicemonitor <path to dsl>') if ARGV.length != 1

dsl_name = ARGV[0]

# Need to remove file name extension
ENV['APP_NAME'] = File.basename(dsl_name) if ENV['APP_NAME'].nil?

$a = MonitorManager.new

log "Loading dsl, #{dsl_name}"
begin
  load dsl_name
  $a.run
rescue ArgumentError
  puts "*** Your dsl is not formatted correctly\n" \
       "*** Ensure each line has the format,\n" \
       "***   <command>, [:arg=>value]\n"
rescue SystemExit
#    rescue SIGTERM=>e
rescue StandardError
  puts 'What the ...'
  puts e.class.name
  puts e.message
end
